<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
</head>
<body>
    <!-- zk -->
    <div class="form-group">
        <div class="input-group col-xs-12">
            <input type="text" class="form-control" id="zkInfo" placeholder="请输入zk地址">
            <span class="input-group-btn">
                <button type="submit" class="btn btn-default" id="zkAddress">配置</button>
            </span>
        </div>
    </div>
    <!-- select -->
    <div class="form-group">
    　　<div class="input-group col-xs-12">
    　      <select class="form-control" id="interfaceName" name="interfaceName" title="请选择调用的接口" data-live-search="true">
                <option disabled selected hidden>请选择调用的接口</option>
            </select>
    　　</div>
        <br/>
        <div class="input-group col-xs-12">
            <select class="form-control" id="methodName" name="methodName" title="请选择调用的方法" data-live-search="true">
                <option disabled selected hidden>请选择调用的方法</option>
            </select>
        </div>
    </div>
    <!-- params -->
    <div class="attachment">
        <h4>上下文参数配置</h4>
        <div class="input-dyna-add" id="attachment-element-box">
            <div class='form-group attach-element-item'>
                <label class="col-sm-1 control-label">key:</label>
                <div class="col-sm-2">
                    <input type="text" class="form-control keyIndex"/>
                </div>
                <label class="col-sm-1 control-label">value:</label>
                <div class="row">
                    <div class="col-sm-3">
                        <input type="text" class="form-control valIndex" placeholder="">
                    </div>
                    <button class='btn btn-danger' type='button' onclick="deleteSelf(this)"><span>删除</span></button>
                </div>
            </div>
        </div>
        <input class='btn btn-info' type="button" id="addAttachmentOpt" onclick="addAttachmentOpt()" value="+添加"/>
        <input class='btn btn-info' type="button" id="saveAttachmentOpt" onclick="saveAttachmentOpt()" value="保存"/>
    </div>

    <div class="paramsBox">
        <h4>方法参数配置</h4>
        <div class="input-dyna-add" id="param-element-box">
            <div class='form-group param-element-item'>
                <label class="col-sm-1 control-label">type:</label>
                <div class="col-sm-2">
                    <input type="text" class="form-control keyIndex">
                </div>
                <label class="col-sm-1 control-label">value:</label>
                <div class="row">
                    <div class="col-sm-3">
                        <input type="text" class="form-control valIndex" placeholder="">
                    </div>
                    <button class='btn btn-danger' type='button' onclick="deleteSelf(this)"><span>删除</span></button>
                </div>
            </div>
        </div>
        <input class='btn btn-info' type="button" id="addParamOpt" onclick="addParamOpt()" value="+添加"/>
        <input class='btn btn-info' type="button" id="saveParamOpt" onclick="saveParamOpt()" value="保存"/>
    </div>


    <!-- invoke method -->
    <div class="form-group">
        <div class="input-group col-xs-12">
            <button type="submit" class="btn btn-default" id="invokeMethod">调用</button>
        </div>
    </div>

    <!-- result -->

</body>

<script>

    $(document).ready(function() {
        $("#zkAddress").click(function() {
            var zkInfo = $("#zkInfo").val();
            $.ajax({
                type: "POST",
                url: "http://127.0.0.1:8084/config",
                contentType: "application/json;charset=UTF-8",
                data: JSON.stringify({"zkUrl": zkInfo}),
                dataType: "json",
                success: function(data) {
                    console.log(data);
                    if(data) {
                        // 请求接口列表
                        getInterface();
                    } else {
                        alert("zk配置失败");
                    }
                },
                error: function() {
                    console.log();
                }
            });
        });
        // interfaceName选中事件
        $("#interfaceName").change(function() {
            var interfacePath = $('#interfaceName').val();
            getMethods(interfacePath);
        });
        // 点击调用按钮触发
        $("#invokeMethod").click(function() {
            var interfacePath = $('#interfaceName').val();
            var methodName = $('#methodName').val();
            var param = {
                "interfacePath": interfacePath,
                "methodName": methodName
            }
            console.log("触发点击事件");
            console.log(param);
        });

    });

    function getInterface() {
        // 请求接口列表
        $.ajax({
            type: "GET",
            url: "http://127.0.0.1:8084/path",
            dataType: "json",
            success: function(data) {
                console.log(data);
                for (let i = 0; i < data.length; i++) {
                    var interfaceName = data[i].interfaceName;
                    $("#interfaceName").append("<option value=' "+ interfaceName +" '>" + interfaceName + "</option>");
                }
            },
            error: function() {

            }
        });
    };

    function getMethods(catalog) {
        // 请求接口方法
        $.ajax({
            type: "GET",
            url: "http://127.0.0.1:8084/method?catalog=" + catalog,
            dataType: "json",
            success: function(data) {
                console.log(data);
                for (let i = 0; i < data.length; i++) {
                    var methodName = data[i];
                    $("#methodName").append("<option value=' "+ methodName +" '>" + methodName + "</option>");
                }
            }
        });
    };

    // 添加上下文输入框
    function addAttachmentOpt() {
        var el = "<div class='form-group attach-element-item'>" +
                    "<label class='col-sm-1 control-label'>key:</label>" +
                    "<div class='col-sm-2'>" +
                        "<input type='text' class='form-control keyIndex'/>" +
                    "</div>" +
                    "<label class='col-sm-1 control-label'>value:</label>" +
                    "<div class='row'>" +
                        "<div class='col-sm-3'>" +
                            "<input type='text' class='form-control valIndex' placeholder=''>" +
                        "</div>" +
                        "<button class='btn btn-danger' type='button' onclick='deleteSelf(this)'><span>删除</span></button>" +
                    "</div>" +
                "</div>";
        $("#attachment-element-box").append(el);
    };

    // 添加参数输入框
    function addParamOpt() {
        var el = "<div class='form-group param-element-item'>" +
                    "<label class='col-sm-1 control-label'>type:</label>" +
                    "<div class='col-sm-2'>" +
                        "<input type='text' class='form-control keyIndex'>" +
                    "</div>" +
                    "<label class='col-sm-1 control-label'>value:</label>" +
                    "<div class='row'>" +
                        "<div class='col-sm-3'>" +
                            "<input type='text' class='form-control valIndex' placeholder=''>" +
                        "</div>" +
                        "<button class='btn btn-danger' type='button' onclick='deleteSelf(this)'><span>删除</span></button>" +
                    "</div>" +
                "</div>";
        $("#param-element-box").append(el);
    };

    // 上下文参数的保存
    function saveAttachmentOpt() {
        // 构建上下文参数
        var attachment = {};
        var a = $("#attachment-element-box").children(".attach-element-item");
        $(a).each(function(index, e) {
            var m1 = $(e).find(".keyIndex").val();
            var m2 = $(e).find(".valIndex").val();
            attachment[m1] = m2;
        });
        console.log(attachment);
    };

    // 请求参数得保存
    function saveParamOpt() {
        // 构建请求参数
        var params = {};
        var a = $("#param-element-box").children(".param-element-item");
        $(a).each(function(index, e) {
            var m1 = $(e).find(".keyIndex").val();
            var m2 = $(e).find(".valIndex").val();
            params[m1] = m2;
        });
        console.log(params);
    };

    // 删除动态添加的元素
    function deleteSelf(el) {
        $(el).closest('.form-group').remove();
    };


</script>

</html>